<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设置 - 1052 AI</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/custom-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Sidebar (Shared Structure) -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">1052 AI</h2>
                <div class="sidebar-controls">
                    <a href="/" class="icon-btn" title="返回聊天">
                        <i class="fas fa-comment-alt"></i>
                    </a>
                    <button id="toggle-sidebar-btn" class="icon-btn" title="收起侧边栏">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
            
            <div class="conversations-list">
                <div class="conversation-item active" data-target="model-settings">
                    <span class="title"><i class="fas fa-robot"></i> 模型配置</span>
                </div>
                <div class="conversation-item" data-target="mcp-settings">
                    <span class="title"><i class="fas fa-server"></i> MCP Servers</span>
                </div>
                <div class="conversation-item" data-target="skills-settings">
                    <span class="title"><i class="fas fa-magic"></i> 技能 (Skills)</span>
                </div>
                <div class="conversation-item" data-target="social-settings">
                    <span class="title"><i class="fas fa-share-alt"></i> 社交平台接入</span>
                </div>
            </div>

            <div class="sidebar-footer">
                <a href="/" class="settings-btn">
                    <i class="fas fa-arrow-left"></i> <span class="btn-text">返回聊天</span>
                </a>
            </div>
        </div>

        <!-- Main Settings Area -->
        <div class="main-chat settings-page-content">
            <div class="chat-header">
                <span>系统设置</span>
            </div>
            
            <div class="settings-scroll-area">
                <div class="settings-container">
                    <!-- Model Settings Section -->
                    <div id="model-settings" class="settings-page-section active">
                        <div class="settings-section">
                            <h3><i class="fas fa-robot"></i> 模型配置</h3>
                            <div class="form-group">
                                <label for="model-provider">Model Provider</label>
                                <select id="model-provider" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                                    <option value="openai">OpenAI Compatible (Remote)</option>
                                    <option value="local">Local Model (Ollama/LocalAI)</option>
                                </select>
                            </div>
                            <div class="form-group" id="api-key-group">
                                <label for="api-key">API Key</label>
                                <input type="password" id="api-key" placeholder="sk-..." autocomplete="off">
                                <p class="help-text">
                                    请输入您的 OpenAI 或兼容服务的 API Key。
                                    <a href="https://cloud.siliconflow.cn/i/QOxdzxkd" target="_blank" style="color: var(--accent-color); margin-left: 5px;">
                                        <i class="fas fa-external-link-alt"></i> 没有 API Key? 点击获取
                                    </a>
                                </p>
                            </div>
                            <div class="form-group">
                                <label for="base-url">Base URL</label>
                                <input type="text" id="base-url" placeholder="https://api.siliconflow.cn/v1">
                                <p class="help-text">API 服务地址，默认为 https://api.siliconflow.cn/v1</p>
                            </div>
                            <div class="form-group">
                                <label for="model-name">Model Name</label>
                                <input type="text" id="model-name" placeholder="deepseek-ai/DeepSeek-V3.2">
                                <p class="help-text">使用的模型名称，如 deepseek-ai/DeepSeek-V3.2 等。</p>
                            </div>
                            <div class="form-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <label for="enable-system-control" style="margin-bottom: 5px; display: block;">系统控制权限 (System Control)</label>
                                        <p class="help-text" style="margin: 0;">允许 AI 执行本地命令 (CMD) 和修改系统文件。关闭后 AI 仅能进行对话和只读操作。</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enable-system-control">
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <label for="enable-self-reflection" style="margin-bottom: 5px; display: block;">自我思考与进化 (Self-Reflection)</label>
                                        <p class="help-text" style="margin: 0;">开启后，AI 将在每次回复后自动进行反思，分析自身不足并尝试自我改进（例如自动查阅文档、编写新技能）。</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enable-self-reflection">
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="settings-actions">
                            <button id="save-settings-btn" class="primary-btn">保存模型配置</button>
                        </div>
                    </div>

                    <!-- MCP Settings Section -->
                    <div id="mcp-settings" class="settings-page-section" style="display: none;">
                        <div class="settings-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin-bottom: 0;"><i class="fas fa-server"></i> MCP Servers</h3>
                                <button id="add-mcp-btn" class="icon-btn" title="添加 Server"><i class="fas fa-plus"></i></button>
                            </div>
                            <div id="mcp-servers-list">
                                <!-- MCP Servers will be injected here -->
                                <p class="help-text" style="text-align: center;">暂无配置的 MCP Server</p>
                            </div>
                        </div>
                    </div>

                    <!-- Skills Settings Section -->
                    <div id="skills-settings" class="settings-page-section" style="display: none;">
                        <div class="settings-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin-bottom: 0;"><i class="fas fa-magic"></i> 本地技能 (Skills)</h3>
                                <button id="add-skill-btn" class="icon-btn" title="上传技能"><i class="fas fa-upload"></i></button>
                            </div>
                            <div id="skills-list">
                                <p class="help-text" style="text-align: center;">加载中...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Social Settings Section -->
                    <div id="social-settings" class="settings-page-section" style="display: none;">
                        <div class="settings-section">
                            <h3><i class="fas fa-share-alt"></i> 社交平台接入</h3>
                            <p class="help-text">配置第三方平台机器人，让 1052 AI 随时随地为您服务。</p>
                            
                            <div class="platforms-grid">
                                <!-- Feishu Card -->
                                <div class="platform-card">
                                    <div class="platform-icon feishu-icon">
                                        <i class="fas fa-comment-dots"></i>
                                    </div>
                                    <div class="platform-info">
                                        <h4>飞书 (Feishu)</h4>
                                        <p>企业级协作平台，支持群聊和单聊。</p>
                                        <span class="status-badge" id="feishu-status">未配置</span>
                                    </div>
                                    <div class="platform-action">
                                        <button class="icon-btn config-social-btn" data-target="feishu-modal">
                                            <i class="fas fa-cog"></i> 配置
                                        </button>
                                    </div>
                                </div>

                                <!-- Telegram Card -->
                                <div class="platform-card">
                                    <div class="platform-icon telegram-icon">
                                        <i class="fab fa-telegram-plane"></i>
                                    </div>
                                    <div class="platform-info">
                                        <h4>Telegram</h4>
                                        <p>全球流行的即时通讯软件，安全快速。</p>
                                        <span class="status-badge" id="telegram-status">未配置</span>
                                    </div>
                                    <div class="platform-action">
                                        <button class="icon-btn config-social-btn" data-target="telegram-modal">
                                            <i class="fas fa-cog"></i> 配置
                                        </button>
                                    </div>
                                </div>

                                <!-- QQ Card -->
                                <div class="platform-card">
                                    <div class="platform-icon qq-icon">
                                        <i class="fab fa-qq"></i>
                                    </div>
                                    <div class="platform-info">
                                        <h4>QQ (OneBot V11)</h4>
                                        <p>通过 NapCatQQ 或 go-cqhttp 接入。</p>
                                        <span class="status-badge" id="qq-status">未配置</span>
                                    </div>
                                    <div class="platform-action">
                                        <button class="icon-btn config-social-btn" data-target="qq-modal">
                                            <i class="fas fa-cog"></i> 配置
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MCP Server Modal -->
    <div id="mcp-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="mcp-modal-title">添加 MCP Server</h3>
                <span class="close-modal" id="close-mcp-modal">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="mcp-id">
                
                <div class="form-group">
                    <label for="mcp-name">名称 (Name)</label>
                    <input type="text" id="mcp-name" placeholder="例如: Filesystem Server">
                </div>

                <div class="form-group">
                    <label for="mcp-config-json">配置 (JSON Config)</label>
                    <textarea id="mcp-config-json" rows="10" placeholder='{
  "command": "npx",
  "args": ["-y", "@modelcontextprotocol/server-filesystem", "C:/Users"]
}' style="font-family: monospace; font-size: 0.9em;"></textarea>
                    <p class="help-text">请直接粘贴 MCP Server 的 JSON 配置。</p>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; align-items: center;">
                <button id="save-mcp-btn" class="primary-btn">确定</button>
            </div>
        </div>
    </div>

    <!-- Skill Upload Modal -->
    <div id="skill-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="skill-modal-title">上传技能包</h3>
                <span class="close-modal" id="close-skill-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="skill-file">选择文件 (.zip 或 .py)</label>
                    <input type="file" id="skill-file" accept=".zip,.py">
                    <p class="help-text">如果是 .zip 包，请确保包内直接包含 .py 文件，系统会自动解压。</p>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; align-items: center;">
                <button id="upload-skill-confirm-btn" class="primary-btn">上传并添加</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Confirm Modal -->
    <div id="custom-modal" class="custom-modal">
        <div class="custom-modal-content">
            <div id="custom-modal-message" class="custom-modal-message"></div>
            <div id="custom-modal-actions" class="custom-modal-actions">
                <!-- Buttons will be injected here -->
            </div>
        </div>
    </div>

    <!-- Feishu Modal -->
    <div id="feishu-modal" class="modal">
        <div class="modal-content" style="width: 600px;">
            <div class="modal-header">
                <h3>飞书机器人配置</h3>
                <span class="close-modal" data-target="feishu-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-tabs">
                    <div class="modal-tab active" data-tab="feishu-config">配置</div>
                    <div class="modal-tab" data-tab="feishu-guide">接入指南</div>
                </div>

                <div id="feishu-config" class="tab-content active">
                    <div class="form-group">
                        <label for="feishu-app-id">App ID</label>
                        <input type="text" id="feishu-app-id" placeholder="cli_..." autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="feishu-app-secret">App Secret</label>
                        <input type="password" id="feishu-app-secret" placeholder="..." autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="feishu-verification-token">Verification Token</label>
                        <input type="text" id="feishu-verification-token" placeholder="..." autocomplete="off">
                    </div>
                    <div class="form-group" style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <label style="margin-bottom: 5px; display: block;">您的请求网址 (Webhook URL)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="feishu-webhook-url" readonly style="background: #e0e0e0; color: #555; cursor: default; flex-grow: 1;">
                            <button class="secondary-btn" id="copy-webhook-btn">复制</button>
                        </div>
                        <p class="help-text" style="margin-top: 8px;">请将此地址填入飞书后台的“请求网址”栏。<strong>注意：飞书要求此地址必须公网可访问 (如使用 ngrok)。</strong></p>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button id="save-feishu-btn" class="primary-btn">保存飞书配置</button>
                    </div>
                </div>

                <div id="feishu-guide" class="tab-content">
                    <div class="guide-step">
                        <strong>1. 创建应用</strong>
                        登录 <a href="https://open.feishu.cn/" target="_blank" style="color: var(--accent-color);">飞书开放平台</a>，创建“企业自建应用”。
                    </div>
                    <div class="guide-step">
                        <strong>2. 获取凭证</strong>
                        在 <strong>凭证与基础信息</strong> 中获取 <code>App ID</code> 和 <code>App Secret</code>。
                    </div>
                    <div class="guide-step">
                        <strong>3. 启用机器人</strong>
                        在 <strong>添加应用能力</strong> 中启用“机器人”。
                    </div>
                    <div class="guide-step">
                        <strong>4. 配置权限</strong>
                        在 <strong>权限管理</strong> 中开通以下权限：
                        <ul style="margin: 5px 0 5px 20px;">
                            <li><code>im:message</code> (获取单聊消息)</li>
                            <li><code>im:message.group_at_msg</code> (获取群聊消息)</li>
                            <li><code>im:message:send_as_bot</code> (以应用身份发消息)</li>
                        </ul>
                        然后点击“发布版本”。
                    </div>
                    <div class="guide-step">
                        <strong>5. 事件订阅</strong>
                        在 <strong>事件订阅</strong> 中配置请求网址 (使用配置页的 Webhook URL)。<br>
                        获取 <strong>Verification Token</strong> 并填入配置。
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram Modal -->
    <div id="telegram-modal" class="modal">
        <div class="modal-content" style="width: 500px;">
            <div class="modal-header">
                <h3>Telegram 机器人配置</h3>
                <span class="close-modal" data-target="telegram-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-tabs">
                    <div class="modal-tab active" data-tab="telegram-config">配置</div>
                    <div class="modal-tab" data-tab="telegram-guide">接入指南</div>
                </div>

                <div id="telegram-config" class="tab-content active">
                    <div class="form-group">
                        <label for="telegram-token">Telegram Bot Token</label>
                        <input type="password" id="telegram-token" placeholder="Enter your Telegram Bot Token" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--bg-primary); color: var(--text-primary);">
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button id="save-telegram-btn" class="primary-btn">保存 Telegram 配置</button>
                    </div>
                </div>

                <div id="telegram-guide" class="tab-content">
                    <div class="guide-step">
                        <strong>1. 寻找 BotFather</strong>
                        在 Telegram 中搜索 <code>@BotFather</code> 并开始对话。
                    </div>
                    <div class="guide-step">
                        <strong>2. 创建新机器人</strong>
                        发送指令 <code>/newbot</code>，按照提示输入机器人的名称和用户名。
                    </div>
                    <div class="guide-step">
                        <strong>3. 获取 Token</strong>
                        创建成功后，BotFather 会发送一串 API Token，将其复制并填入配置。
                    </div>
                    <div class="guide-step">
                        <strong>4. 重启生效</strong>
                        保存配置后，建议重启本应用以确保连接生效。
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QQ Modal -->
    <div id="qq-modal" class="modal">
        <div class="modal-content" style="width: 600px;">
            <div class="modal-header">
                <h3>QQ 机器人配置 (OneBot V11)</h3>
                <span class="close-modal" data-target="qq-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-tabs">
                    <div class="modal-tab active" data-tab="qq-config">配置</div>
                    <div class="modal-tab" data-tab="qq-guide">接入指南</div>
                </div>

                <div id="qq-config" class="tab-content active">
                    <div class="form-group">
                        <label for="qq-http-api">HTTP API 地址</label>
                        <input type="text" id="qq-http-api" placeholder="http://127.0.0.1:3000" autocomplete="off">
                        <p class="help-text">NapCatQQ 或 go-cqhttp 监听的 HTTP API 地址。</p>
                    </div>
                    <div class="form-group">
                        <label for="qq-access-token">Access Token (可选)</label>
                        <input type="password" id="qq-access-token" placeholder="..." autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="qq-secret">Secret (可选)</label>
                        <input type="password" id="qq-secret" placeholder="..." autocomplete="off">
                    </div>
                    
                    <div class="form-group" style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <label style="margin-bottom: 5px; display: block;">事件上报地址 (Webhook URL)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="qq-webhook-url" readonly style="background: #e0e0e0; color: #555; cursor: default; flex-grow: 1;">
                            <button class="secondary-btn" id="copy-qq-webhook-btn">复制</button>
                        </div>
                        <p class="help-text" style="margin-top: 8px;">请将此地址填入 NapCatQQ 或 go-cqhttp 的 <code>post_urls</code> (HTTP 上报) 配置中。</p>
                    </div>

                    <div style="text-align: right; margin-top: 20px;">
                        <button id="save-qq-btn" class="primary-btn">保存 QQ 配置</button>
                    </div>
                </div>

                <div id="qq-guide" class="tab-content">
                    <div class="guide-step">
                        <strong>1. 安装 OneBot 客户端</strong>
                        推荐使用 <a href="https://github.com/NapNeko/NapCatQQ" target="_blank" style="color: var(--accent-color);">NapCatQQ</a> (基于 NTQQ，更稳定)。
                    </div>
                    <div class="guide-step">
                        <strong>2. 配置 HTTP 交互</strong>
                        在 NapCatQQ 的配置文件 (<code>napcat.json</code>) 中：
                        <ul style="margin: 5px 0 5px 20px;">
                            <li>启用 <code>http</code> 并在 <code>port</code> 设置端口 (如 3000)，填入本页面的 <strong>HTTP API 地址</strong>。</li>
                            <li>启用 <code>http_webhook</code> 并将本页面的 <strong>Webhook URL</strong> 填入 <code>post_urls</code>。</li>
                        </ul>
                    </div>
                    <div class="guide-step">
                        <strong>3. 重启生效</strong>
                        保存配置后，重启 1052 AI 和 NapCatQQ。
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/common.js"></script>
    <script>
        // Custom UI Helpers (Implemented in common.js)
 
        // Settings Page Logic
        document.addEventListener('DOMContentLoaded', async () => {
            
            function updateSocialStatus(settings) {
                const feishuStatus = document.getElementById('feishu-status');
                const telegramStatus = document.getElementById('telegram-status');
                const qqStatus = document.getElementById('qq-status');
                
                if (settings.feishu_app_id && settings.feishu_app_secret) {
                    feishuStatus.textContent = '已配置';
                    feishuStatus.classList.add('configured');
                } else {
                    feishuStatus.textContent = '未配置';
                    feishuStatus.classList.remove('configured');
                }
                
                if (settings.telegram_token) {
                    telegramStatus.textContent = '已配置';
                    telegramStatus.classList.add('configured');
                } else {
                    telegramStatus.textContent = '未配置';
                    telegramStatus.classList.remove('configured');
                }

                if (settings.qq_http_api) {
                    qqStatus.textContent = '已配置';
                    qqStatus.classList.add('configured');
                } else {
                    qqStatus.textContent = '未配置';
                    qqStatus.classList.remove('configured');
                }
            }

            // Navigation Logic
            const navItems = document.querySelectorAll('.conversation-item');
            const sections = document.querySelectorAll('.settings-page-section');

            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    // Remove active class from all items
                    navItems.forEach(nav => nav.classList.remove('active'));
                    // Add active class to clicked item
                    item.classList.add('active');

                    // Hide all sections
                    sections.forEach(section => {
                        section.style.display = 'none';
                        section.classList.remove('active');
                    });

                    // Show target section
                    const targetId = item.dataset.target;
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                        targetSection.classList.add('active');
                    }
                });
            });

            // Initial Load logic...
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                
                document.getElementById('api-key').value = settings.api_key || '';
                document.getElementById('base-url').value = settings.base_url || '';
                document.getElementById('model-name').value = settings.model || '';
                document.getElementById('model-provider').value = settings.model_provider || 'openai';
                
                // Trigger provider change to update UI
                const providerSelect = document.getElementById('model-provider');
                // Manually set initial state since listener might not be attached yet
                if (settings.model_provider === 'local') {
                    document.getElementById('api-key-group').style.display = 'none';
                } else {
                    document.getElementById('api-key-group').style.display = 'block';
                }

                document.getElementById('enable-system-control').checked = settings.enable_system_control === 'true';
                document.getElementById('enable-self-reflection').checked = settings.enable_self_reflection === 'true';

                // Load Social Settings
                document.getElementById('feishu-app-id').value = settings.feishu_app_id || '';
                document.getElementById('feishu-app-secret').value = settings.feishu_app_secret || '';
                document.getElementById('feishu-verification-token').value = settings.feishu_verification_token || '';
                document.getElementById('telegram-token').value = settings.telegram_token || '';
                
                document.getElementById('qq-http-api').value = settings.qq_http_api || '';
                document.getElementById('qq-access-token').value = settings.qq_access_token || '';
                document.getElementById('qq-secret').value = settings.qq_secret || '';

                // Calculate Webhook URL
                const protocol = window.location.protocol;
                const host = window.location.host;
                document.getElementById('feishu-webhook-url').value = `${protocol}//${host}/api/feishu/event`;
                document.getElementById('qq-webhook-url').value = `${protocol}//${host}/api/qq/event`;

                // Update Social Status Badges
                updateSocialStatus(settings);

            } catch (error) {
                console.error('Failed to load settings:', error);
                showCustomAlert('加载设置失败，请检查网络。');
            }

            // MCP Logic
            const mcpList = document.getElementById('mcp-servers-list');
            const addMcpBtn = document.getElementById('add-mcp-btn');
            const mcpModal = document.getElementById('mcp-modal');
            const closeMcpModal = document.getElementById('close-mcp-modal');
            const saveMcpBtn = document.getElementById('save-mcp-btn');

            
            // Import Logic removed

            
            async function loadMcpServers() {
                try {
                    const response = await fetch('/api/mcp_servers');
                    const servers = await response.json();
                    
                    if (servers.length === 0) {
                        mcpList.innerHTML = '<p class="help-text" style="text-align: center;">暂无配置的 MCP Server</p>';
                        return;
                    }

                    mcpList.innerHTML = '';
                    servers.forEach(server => {
                        const div = document.createElement('div');
                        div.style.padding = '15px';
                        div.style.border = '1px solid var(--border-color)';
                        div.style.borderRadius = '8px';
                        div.style.marginBottom = '15px';
                        div.style.display = 'flex';
                        div.style.justifyContent = 'space-between';
                        div.style.alignItems = 'center';
                        div.style.backgroundColor = 'var(--bg-secondary)';

                        div.innerHTML = `
                            <div style="flex-grow: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                    <strong style="color: var(--accent-color); font-size: 1.1em;">${server.name}</strong>
                                    <span style="background: var(--bg-primary); padding: 2px 8px; border-radius: 4px; font-size: 0.8em; color: var(--text-secondary); border: 1px solid var(--border-color);">${server.type}</span>
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.9em; font-family: monospace;">
                                    ${server.type === 'stdio' ? server.command : server.url}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <label class="toggle-switch" title="启用/禁用">
                                    <input type="checkbox" class="mcp-toggle" data-id="${server.id}" ${server.enabled ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                                <div style="display: flex; gap: 5px;">
                                    <button class="icon-btn edit-mcp-btn" data-id="${server.id}" title="编辑"><i class="fas fa-edit"></i></button>
                                    <button class="icon-btn delete-mcp-btn" data-id="${server.id}" title="删除" style="color: #ff4d4d;"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `;
                        
                        // Bind events
                        const toggle = div.querySelector('.mcp-toggle');
                        toggle.addEventListener('change', async (e) => {
                            const enabled = e.target.checked;
                            try {
                                await fetch(`/api/mcp_servers/${server.id}`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ enabled: enabled ? 1 : 0 })
                                });
                            } catch (error) {
                                console.error('Failed to update status', error);
                                e.target.checked = !enabled; // Revert
                                showCustomAlert('更新状态失败');
                            }
                        });

                        div.querySelector('.delete-mcp-btn').onclick = async () => {
                            if (await showCustomConfirm(`确定要删除 ${server.name} 吗？`)) {
                                await fetch(`/api/mcp_servers/${server.id}`, { method: 'DELETE' });
                                loadMcpServers();
                            }
                        };
                        
                        div.querySelector('.edit-mcp-btn').onclick = () => {
                            openMcpModal(server);
                        };

                        mcpList.appendChild(div);
                    });
                } catch (error) {
                    console.error('Failed to load MCP servers:', error);
                }
            }

            function openMcpModal(server = null) {
                const title = document.getElementById('mcp-modal-title');
                const idInput = document.getElementById('mcp-id');
                const nameInput = document.getElementById('mcp-name');
                const configInput = document.getElementById('mcp-config-json');

                if (server) {
                    title.textContent = '编辑 MCP Server';
                    idInput.value = server.id;
                    nameInput.value = server.name;
                    
                    let config = {};
                    if (server.type === 'stdio') {
                        config.command = server.command;
                        try {
                            config.args = server.args ? JSON.parse(server.args) : [];
                        } catch (e) { config.args = []; }
                        try {
                            config.env = server.env ? JSON.parse(server.env) : {};
                        } catch (e) { config.env = {}; }
                    } else if (server.type === 'sse') {
                        config.url = server.url;
                    }
                    
                    configInput.value = JSON.stringify(config, null, 2);
                } else {
                    title.textContent = '添加 MCP Server';
                    idInput.value = '';
                    nameInput.value = '';
                    configInput.value = '';
                }
                
                mcpModal.style.display = 'block';
            }


            
            addMcpBtn.addEventListener('click', () => openMcpModal());
            
            closeMcpModal.addEventListener('click', () => {
                mcpModal.style.display = 'none';
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === mcpModal) mcpModal.style.display = 'none';
            });



            // Intelligent MCP Config Parser
            function parseMcpConfig(configStr, currentName) {
                if (!configStr) throw new Error('配置不能为空');
                
                let config;
                try {
                    config = JSON.parse(configStr);
                } catch (e) {
                    throw new Error('JSON 格式错误: ' + e.message);
                }

                let name = currentName;
                let finalConfig = {};

                // Case 0: Array Input (Args only) -> default npx
                if (Array.isArray(config)) {
                    finalConfig = {
                        command: 'npx',
                        args: config,
                        env: {}
                    };
                }
                // Case 1: "mcpServers" wrapper
                else if (config.mcpServers && typeof config.mcpServers === 'object') {
                    const keys = Object.keys(config.mcpServers);
                    if (keys.length > 0) {
                        // Use first server found
                        const key = keys[0];
                        if (!name) name = key;
                        finalConfig = config.mcpServers[key];
                    } else {
                        throw new Error('mcpServers 对象为空');
                    }
                }
                // Case 2: Single Key Wrapper (e.g. {"filesystem": {...}})
                // Heuristic: If it has no command/url/args but has a child that does
                else if (!config.command && !config.url && !config.args) {
                    const keys = Object.keys(config);
                    // Check if the first child looks like a config
                    if (keys.length > 0) {
                         // Try to find a valid config in children
                         let found = false;
                         for (const key of keys) {
                             const child = config[key];
                             if (child && typeof child === 'object' && (child.command || child.url || child.args)) {
                                 if (!name) name = key;
                                 finalConfig = child;
                                 found = true;
                                 break;
                             }
                         }
                         
                         // If not found, maybe the user really meant an empty object or custom env?
                         // But if keys.length === 1, assume it's a wrapper
                         if (!found && keys.length === 1) {
                             // Fallback: assume the inner object IS the config, even if missing fields (will use defaults)
                             if (!name) name = keys[0];
                             finalConfig = config[keys[0]];
                         } else if (!found) {
                             // Treat as direct config (maybe just env?)
                             finalConfig = config;
                         }
                    } else {
                        finalConfig = config;
                    }
                }
                // Case 3: Direct Config
                else {
                    finalConfig = config;
                }

                // Normalize fields
                let type = 'stdio';
                let command = null;
                let args = [];
                let env = {};
                let url = null;

                if (finalConfig.url) {
                    type = 'sse';
                    url = finalConfig.url;
                } else {
                    type = 'stdio';
                    command = finalConfig.command || 'npx';
                    args = finalConfig.args || [];
                    env = finalConfig.env || {};
                }
                
                return {
                    name,
                    type,
                    command,
                    args,
                    env,
                    url
                };
            }

            saveMcpBtn.addEventListener('click', async () => {
                const id = document.getElementById('mcp-id').value;
                const nameInput = document.getElementById('mcp-name');
                const configStr = document.getElementById('mcp-config-json').value.trim();

                let parsed;
                try {
                    parsed = parseMcpConfig(configStr, nameInput.value.trim());
                } catch (e) {
                    await showCustomAlert(e.message);
                    return;
                }

                if (!parsed.name) {
                    await showCustomAlert('无法自动识别名称，请在“名称”栏输入 Server 名称');
                    return;
                }
                
                // Update UI with inferred name if it was empty
                if (!nameInput.value.trim()) {
                    nameInput.value = parsed.name;
                }

                const payload = {
                    name: parsed.name,
                    type: parsed.type,
                    command: parsed.command,
                    args: parsed.args,
                    env: parsed.env,
                    url: parsed.url
                };

                // UI Feedback - Start Test
                const originalBtnText = saveMcpBtn.textContent;
                saveMcpBtn.textContent = '验证连接...';
                saveMcpBtn.disabled = true;
                
                let testPassed = false;
                let testMessage = '';

                try {
                    // Try to connect first
                    const testResponse = await fetch('/api/mcp_servers/test', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const testResult = await testResponse.json();
                    
                    if (testResult.status === 'success') {
                        testPassed = true;
                        testMessage = testResult.message;
                    } else {
                        testPassed = false;
                        testMessage = testResult.message;
                    }
                } catch (error) {
                    testPassed = false;
                    testMessage = '网络连接错误';
                }

                // Restore button state
                saveMcpBtn.textContent = originalBtnText;
                saveMcpBtn.disabled = false;

                // Decision logic
                let proceedToSave = false;

                if (testPassed) {
                    proceedToSave = true;
                } else {
                    // Ask user if they want to force save
                    const confirmSave = await showCustomConfirm(`连接失败: ${testMessage}\n\n是否仍然保存此配置？`);
                    if (confirmSave) {
                        proceedToSave = true;
                    }
                }

                if (proceedToSave) {
                    const method = id ? 'PUT' : 'POST';
                    const urlPath = id ? `/api/mcp_servers/${id}` : '/api/mcp_servers';

                    try {
                        await fetch(urlPath, {
                            method: method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        mcpModal.style.display = 'none';
                        loadMcpServers();
                        
                        if (testPassed) {
                            showCustomAlert('保存成功！\n' + testMessage);
                        } else {
                            showCustomAlert('已强制保存 (连接失败)。');
                        }
                    } catch (error) {
                        console.error('Failed to save MCP server:', error);
                        showCustomAlert('保存失败');
                    }
                }
            });

            // Initial Load
            loadMcpServers();
            loadSkills();

            // Skills Logic
            const skillsList = document.getElementById('skills-list');
            const addSkillBtn = document.getElementById('add-skill-btn');
            const skillModal = document.getElementById('skill-modal');
            const closeSkillModal = document.getElementById('close-skill-modal');
            const uploadSkillBtn = document.getElementById('upload-skill-confirm-btn');
            const skillFileInput = document.getElementById('skill-file');

            async function loadSkills() {
                try {
                    const response = await fetch('/api/skills');
                    const skills = await response.json();
                    
                    if (skills.length === 0) {
                        skillsList.innerHTML = '<p class="help-text" style="text-align: center;">暂无本地技能</p>';
                        return;
                    }

                    skillsList.innerHTML = '';
                    skills.forEach(skill => {
                        const div = document.createElement('div');
                        div.style.padding = '15px';
                        div.style.border = '1px solid var(--border-color)';
                        div.style.borderRadius = '8px';
                        div.style.marginBottom = '15px';
                        div.style.display = 'flex';
                        div.style.justifyContent = 'space-between';
                        div.style.alignItems = 'center';
                        div.style.backgroundColor = 'var(--bg-secondary)';

                        // Format functions list
                        let descriptionHtml = '';
                        if (skill.description) {
                            // Truncate description if too long
                            const shortDesc = skill.description.length > 150 ? skill.description.substring(0, 150) + '...' : skill.description;
                            descriptionHtml = `<div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 5px; white-space: pre-wrap; font-family: monospace; background: rgba(0,0,0,0.1); padding: 5px; border-radius: 4px;">${shortDesc}</div>`;
                        } else {
                            descriptionHtml = `<div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 5px; font-style: italic;">No description (README.md not found)</div>`;
                        }

                        div.innerHTML = `
                            <div style="flex-grow: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                    <strong style="color: var(--accent-color); font-size: 1.1em;">
                                        <i class="${skill.is_folder ? 'fas fa-folder' : 'fas fa-file-code'}"></i> 
                                        ${skill.name}
                                    </strong>
                                </div>
                                <div style="padding-left: 5px;">
                                    ${descriptionHtml}
                                </div>
                            </div>
                            <div>
                                <button class="icon-btn delete-skill-btn" data-filename="${skill.name}" title="删除" style="color: #ff4d4d;"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        
                        div.querySelector('.delete-skill-btn').onclick = async () => {
                            if (await showCustomConfirm(`确定要删除技能 "${skill.name}" 吗？\n(这将删除整个文件夹/文件)`)) {
                                try {
                                    const res = await fetch(`/api/skills/${skill.name}`, { method: 'DELETE' });
                                    if (res.ok) {
                                        loadSkills();
                                        showCustomAlert('删除成功');
                                    } else {
                                        const err = await res.json();
                                        showCustomAlert('删除失败: ' + err.error);
                                    }
                                } catch (e) {
                                    showCustomAlert('删除失败: ' + e.message);
                                }
                            }
                        };

                        skillsList.appendChild(div);
                    });
                } catch (error) {
                    console.error('Failed to load skills:', error);
                    skillsList.innerHTML = '<p class="help-text" style="text-align: center; color: #ff4d4d;">加载失败</p>';
                }
            }

            addSkillBtn.addEventListener('click', () => {
                skillFileInput.value = '';
                skillModal.style.display = 'block';
            });

            closeSkillModal.addEventListener('click', () => {
                skillModal.style.display = 'none';
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === skillModal) skillModal.style.display = 'none';
            });

            uploadSkillBtn.addEventListener('click', async () => {
                const file = skillFileInput.files[0];
                if (!file) {
                    await showCustomAlert('请选择文件');
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);

                const originalText = uploadSkillBtn.textContent;
                uploadSkillBtn.textContent = '上传中...';
                uploadSkillBtn.disabled = true;

                try {
                    const response = await fetch('/api/skills', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();

                    if (response.ok) {
                        skillModal.style.display = 'none';
                        loadSkills();
                        showCustomAlert(result.message);
                    } else {
                        showCustomAlert('上传失败: ' + (result.error || result.message));
                    }
                } catch (error) {
                    console.error(error);
                    showCustomAlert('网络错误');
                } finally {
                    uploadSkillBtn.textContent = originalText;
                    uploadSkillBtn.disabled = false;
                }
            });

            // Provider Toggle Logic
            const providerSelect = document.getElementById('model-provider');
            const apiKeyGroup = document.getElementById('api-key-group');
            const apiKeyInput = document.getElementById('api-key');
            const baseUrlInput = document.getElementById('base-url');
            const modelNameInput = document.getElementById('model-name');
            
            providerSelect.addEventListener('change', () => {
                const provider = providerSelect.value;
                if (provider === 'local') {
                    // Local Model: Hide API Key, set default URL if empty
                    apiKeyGroup.style.display = 'none';
                    if (!baseUrlInput.value || baseUrlInput.value.includes('api.openai.com')) {
                        baseUrlInput.value = 'http://localhost:11434/v1';
                    }
                    if (!modelNameInput.value || modelNameInput.value.includes('gpt-')) {
                        modelNameInput.value = 'llama3';
                    }
                } else {
                    // OpenAI: Show API Key
                    apiKeyGroup.style.display = 'block';
                    if (baseUrlInput.value.includes('localhost') || baseUrlInput.value === '') {
                        baseUrlInput.value = 'https://api.siliconflow.cn/v1';
                    }
                    if (modelNameInput.value === 'llama3' || modelNameInput.value === '' || modelNameInput.value === 'gpt-3.5-turbo') {
                        modelNameInput.value = 'deepseek-ai/DeepSeek-V3.2';
                    }
                }
            });

            document.getElementById('save-settings-btn').addEventListener('click', async () => {
                const apiKey = document.getElementById('api-key').value.trim();
                const baseUrl = document.getElementById('base-url').value.trim();
                const model = document.getElementById('model-name').value.trim();
                const systemControl = document.getElementById('enable-system-control').checked;
                const selfReflection = document.getElementById('enable-self-reflection').checked;
                const provider = document.getElementById('model-provider').value;

                try {
                    await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            api_key: apiKey,
                            base_url: baseUrl,
                            model: model,
                            enable_system_control: systemControl ? 'true' : 'false',
                            enable_self_reflection: selfReflection ? 'true' : 'false',
                            model_provider: provider
                        })
                    });
                    await showCustomAlert('设置已保存');
                } catch (error) {
                    console.error('Failed to save settings:', error);
                    showCustomAlert('保存设置失败。');
                }
            });

            // Social Settings Logic (New)
            const configBtns = document.querySelectorAll('.config-social-btn');
            const closeButtons = document.querySelectorAll('.close-modal');
            const tabs = document.querySelectorAll('.modal-tab');

            configBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.dataset.target;
                    const modal = document.getElementById(targetId);
                    if (modal) modal.style.display = 'block';
                });
            });

            closeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.dataset.target;
                    if (targetId) {
                        const modal = document.getElementById(targetId);
                        if (modal) modal.style.display = 'none';
                    }
                });
            });

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const parentHeader = tab.parentElement;
                    const siblings = parentHeader.querySelectorAll('.modal-tab');
                    siblings.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const targetId = tab.dataset.tab;
                    const modalBody = parentHeader.parentElement;
                    const contents = modalBody.querySelectorAll('.tab-content');
                    contents.forEach(c => c.classList.remove('active'));
                    
                    const targetContent = document.getElementById(targetId);
                    if (targetContent) targetContent.classList.add('active');
                });
            });

            document.getElementById('save-feishu-btn').addEventListener('click', async () => {
                const feishuId = document.getElementById('feishu-app-id').value.trim();
                const feishuSecret = document.getElementById('feishu-app-secret').value.trim();
                const feishuToken = document.getElementById('feishu-verification-token').value.trim();

                try {
                    await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            feishu_app_id: feishuId,
                            feishu_app_secret: feishuSecret,
                            feishu_verification_token: feishuToken
                        })
                    });
                    
                    // Update status badge
                    updateSocialStatus({
                        feishu_app_id: feishuId,
                        feishu_app_secret: feishuSecret,
                        telegram_token: document.getElementById('telegram-token').value.trim() // Keep existing
                    });
                    
                    document.getElementById('feishu-modal').style.display = 'none';
                    await showCustomAlert('飞书配置已保存');
                } catch (error) {
                    console.error('Failed to save feishu settings:', error);
                    showCustomAlert('保存失败。');
                }
            });

            document.getElementById('save-telegram-btn').addEventListener('click', async () => {
                const telegramToken = document.getElementById('telegram-token').value.trim();

                try {
                    await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            telegram_token: telegramToken
                        })
                    });
                    
                    updateSocialStatus({
                        feishu_app_id: document.getElementById('feishu-app-id').value.trim(),
                        feishu_app_secret: document.getElementById('feishu-app-secret').value.trim(),
                        telegram_token: telegramToken,
                        qq_http_api: document.getElementById('qq-http-api').value.trim()
                    });
                    
                    document.getElementById('telegram-modal').style.display = 'none';
                    await showCustomAlert('Telegram 配置已保存');
                } catch (error) {
                    console.error('Failed to save telegram settings:', error);
                    showCustomAlert('保存失败。');
                }
            });

            document.getElementById('save-qq-btn').addEventListener('click', async () => {
                const httpApi = document.getElementById('qq-http-api').value.trim();
                const accessToken = document.getElementById('qq-access-token').value.trim();
                const secret = document.getElementById('qq-secret').value.trim();

                try {
                    await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            qq_http_api: httpApi,
                            qq_access_token: accessToken,
                            qq_secret: secret
                        })
                    });
                    
                    updateSocialStatus({
                        feishu_app_id: document.getElementById('feishu-app-id').value.trim(),
                        feishu_app_secret: document.getElementById('feishu-app-secret').value.trim(),
                        telegram_token: document.getElementById('telegram-token').value.trim(),
                        qq_http_api: httpApi
                    });
                    
                    document.getElementById('qq-modal').style.display = 'none';
                    await showCustomAlert('QQ 配置已保存');
                } catch (error) {
                    console.error('Failed to save qq settings:', error);
                    showCustomAlert('保存失败。');
                }
            });
            
            // Copy Webhook URL (Feishu)
            document.getElementById('copy-webhook-btn').addEventListener('click', () => {
                const urlInput = document.getElementById('feishu-webhook-url');
                urlInput.select();
                document.execCommand('copy'); // Fallback
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(urlInput.value).then(() => {
                        showCustomAlert('已复制到剪贴板');
                    });
                } else {
                    showCustomAlert('已复制 (Legacy)');
                }
            });

            // Copy Webhook URL (QQ)
            document.getElementById('copy-qq-webhook-btn').addEventListener('click', () => {
                const urlInput = document.getElementById('qq-webhook-url');
                urlInput.select();
                document.execCommand('copy'); // Fallback
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(urlInput.value).then(() => {
                        showCustomAlert('已复制到剪贴板');
                    });
                } else {
                    showCustomAlert('已复制 (Legacy)');
                }
            });
        });
    </script>
</body>
</html>
